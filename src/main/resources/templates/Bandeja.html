<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bandeja de Entrada</title>
</head>
<style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #272829;
}

h1 {
    text-align: center;
    margin-top: 20px;
    color: white;
}

h5 {
    text-align: center;
    margin-bottom: 20px;
    color: white;
}

#messages {
    display: flex;
    flex-direction: column;
    height: 70vh; /* Ajusta la altura del área de mensajes */
    overflow-y: auto;
    padding: 10px;
    
    background-color: #3A3B3C;
    margin-bottom: 20px; /* Espacio adicional en la parte inferior del área de mensajes */
}

.mensaje-item {
    max-width: 70%;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
    background-color: #272829;
}

.mensaje-item.sent {
    align-self: flex-end;
    background-color: #007bff;
    color: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    max-width: 80%;
}

.mensaje-item.received {
    align-self: flex-start;
    background-color: #272829;
    color: white;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    max-width: 80%;
}

.input-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    
    background-color: #3A3B3C;
}

input[type="text"] {
    flex: 1;
    padding: 10px;
    background-color: #272829;
    border-radius: 4px;
}

button {
    background-color: #007bff;
    color: #fff;
    border: none;
    padding: 10px;
    margin-left: 10px;
    border-radius: 4px;
    cursor: pointer;
}

button:hover {
    background-color: #0056b3;
}
</style>
<body>
    <h1>Bandeja de Entrada</h1>
    <h5>Chat con <span th:text="${contacto.username}">Nombre del contacto</span></h5>
    <input type="hidden" id="contactId" th:value="${contacto.id}">
    <input type="hidden" id="currentUserId" th:value="${usuarioActual.id}">

    <div id="messages">
        <!-- Aquí se mostrarán los mensajes -->
        <div th:each="mensaje : ${mensajes}" class="mensaje-item"
             th:classappend="${mensaje.remitente.id == usuarioActual.id ? 'sent' : 'received'}">
            <p th:text="${mensaje.contenido}"></p>
            <small th:text="${mensaje.fechaEnvio}"></small>
        </div>
    </div>

    <div class="input-container">
        <input type="text" id="messageInput" placeholder="Escribe tu mensaje aquí">
        <button id="sendMessageButton">Enviar</button>
    </div>

    



    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let contactId = document.getElementById('contactId').value;
        let currentUserId = document.getElementById('currentUserId').value;
        
        function connect() {
            let socket = new SockJS('/chat');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                stompClient.subscribe('/topic/messages', function (messageOutput) {
                    let message = JSON.parse(messageOutput.body);
                    console.log('Message received:', message);
                    showMessage(message);
                });
            }, function (error) {
                console.error('STOMP error:', error);
            });
        }

        function sendMessage() {
            let messageContent = document.getElementById('messageInput').value;
            let message = {
                contenido: messageContent,
                destinatario: { id: contactId },
                remitente: { id: currentUserId } 
            };
        
            if (!message.destinatario) {
                console.error("El destinatario no está definido.");
                return;
            }
        
            stompClient.send("/app/chat.send", {}, JSON.stringify(message));
        }
        
        function showMessage(message) {
            console.log('Showing message:', message);
            let messagesDiv = document.getElementById('messages');
            let messageElement = document.createElement('div');
            messageElement.className = 'mensaje-item';
            messageElement.classList.add(message.remitente.id === parseInt(currentUserId) ? 'sent' : 'received');
            messageElement.innerHTML = `<p>${message.contenido}</p><small>${message.fechaEnvio || 'Hace un momento'}</small>`;
            messagesDiv.appendChild(messageElement);
        }
        
        document.getElementById('sendMessageButton').addEventListener('click', sendMessage);
        connect();
    </script>
</body>
</html>